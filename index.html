<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="manifest" href="manifest.json">

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Minutagens</title>

<style>
/* RESET */
body {
    margin: 0;
    padding: 0;
    background: #1e1e1e;
    font-family: Arial, sans-serif;

    display: flex;
    justify-content: center;
    align-items: center;

    width: 100vw;
    height: 100vh;
}

/* CONTAINER 9:16 */
#app {
    width: 100vw;
    max-width: 430px;
    height: 100vh;
    aspect-ratio: 9 / 16;
    background: #e5e5e5;
    display: flex;
    flex-direction: column;
}

#app * {
    box-sizing: border-box;
}

/* TOPO */
#tasks {
    background: #e5e5e5;
    padding: 10px;
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}

.task {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    color: #000;
}

.task.active {
    font-size: 22px;
    border: 2px solid #000;
}

button {
    cursor: pointer;
}

button[onclick="addTask()"] {
    width: 30px;
    height: 30px;
    font-size: 20px;
    background: #666;
    color: white;
    border: none;
    border-radius: 4px;
}

hr {
    width: 100%;
    border: none;
    height: 10px;
    background: #e5e5e5;
    margin: 0;
}

/* BLOCO CENTRAL */
#screen {
    background: #e5e5e5;
    padding: 15px;
    flex: 1;
}

/* BLOCO DE NOTAS */
#notes {
    width: 100%;
    height: 100%;
    background: #6b6b6b;
    color: white;
    border: none;
    resize: none;
    font-size: 18px;
    padding: 10px;
}

/* TECLADO */
#keyboard {
    background: #e5e5e5;
    padding: 10px;
    text-align: center;
}

#keyboard button {
    width: 60px;
    height: 50px;
    margin: 5px;
    font-size: 18px;
    background: #555;
    color: white;
    border: none;
    border-radius: 6px;
}

/* RODAPÃ‰ */
#footer {
    background: #e5e5e5;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#totalTime {
    font-size: 22px;
    font-weight: bold;
}

#playBtn {
    width: 50px;
    height: 40px;
    font-size: 20px;
    background: #555;
    color: white;
    border: none;
    border-radius: 6px;
}

/* SELETOR DE CORES */
#colorPicker {
    position: fixed;
    bottom: 80px;
    background: #333;
    padding: 10px;
    border-radius: 10px;
    display: none;
    gap: 10px;
}

.colorOption {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid #fff;
}
</style>
</head>

<body>

<div id="app">

    <!-- TOPO -->
    <div id="tasks"></div>
    <button onclick="addTask()">+</button>

    <hr>

    <!-- BLOCO CENTRAL -->
    <div id="screen" onclick="showPhoneKeyboard()">
        <textarea id="notes" placeholder="Digite os tempos..."></textarea>
    </div>

    <!-- TECLADO -->
    <div id="keyboard" style="display:none;">
        <button onclick="press('1')">1</button>
        <button onclick="press('2')">2</button>
        <button onclick="press('3')">3</button><br>
        <button onclick="press('4')">4</button>
        <button onclick="press('5')">5</button>
        <button onclick="press('6')">6</button><br>
        <button onclick="press('7')">7</button>
        <button onclick="press('8')">8</button>
        <button onclick="press('9')">9</button><br>
        <button onclick="press(':')">*</button>
        <button onclick="press('0')">0</button>
        <button onclick="newline()">â†µ</button>
    </div>

    <hr>

    <!-- RODAPÃ‰ -->
    <div id="footer">
        <span id="totalTime">00:00</span>
        <button onclick="togglePlay()" id="playBtn">â–¶</button>
        <button onclick="clearNotes()">ðŸ—‘</button>
    </div>

</div>

<!-- PAINEL DE CORES -->
<div id="colorPicker">
    <div class="colorOption" style="background:#4da3ff" onclick="setTaskColor('#4da3ff')"></div>
    <div class="colorOption" style="background:#ffd84d" onclick="setTaskColor('#ffd84d')"></div>
    <div class="colorOption" style="background:#ff5c5c" onclick="setTaskColor('#ff5c5c')"></div>
    <div class="colorOption" style="background:#b57bff" onclick="setTaskColor('#b57bff')"></div>
</div>

<script>
let timerInterval;
let totalSeconds = 0;
let isRunning = false;
let currentIndex = 0;
let sequence = [];

/* =========================
   LOOPING PARSER
========================= */

function buildSequence() {
    const text = document.getElementById("notes").value.trim().toUpperCase();
    const lines = text.split("\n").map(l => l.trim()).filter(l => l !== "");

    sequence = [];

    let loopCount = 1;
    let loopStart = -1;
    let loopEnd = -1;

    lines.forEach((line, index) => {
        if (line.startsWith("LOOPING")) {
            const match = line.match(/LOOPING\s+(\d+)X/);
            if (match) {
                loopCount = parseInt(match[1]);
                loopStart = index + 1;
            }
        }

        if (line === "END") {
            loopEnd = index;
        }
    });

    const normalTimes = [];
    const loopTimes = [];

    lines.forEach((line, index) => {
        if (/^\d+:\d+$/.test(line)) {
            if (loopStart !== -1 && loopEnd !== -1) {
                if (index >= loopStart && index < loopEnd) {
                    loopTimes.push(line);
                } else if (index > loopEnd) {
                    normalTimes.push(line);
                }
            } else if (loopStart !== -1) {
                if (index >= loopStart) {
                    loopTimes.push(line);
                }
            } else {
                normalTimes.push(line);
            }
        }
    });

    if (loopTimes.length > 0) {
        for (let i = 0; i < loopCount; i++) {
            sequence.push(...loopTimes);
        }
    }

    sequence.push(...normalTimes);
}

/* =========================
   TIMER
========================= */

function togglePlay() {
    if (isRunning) {
        pauseTimer();
    } else {
        startTimer();
    }
}

function startTimer() {
    if (sequence.length === 0) {
        buildSequence();
        currentIndex = 0;
    }

    if (currentIndex >= sequence.length) return;

    isRunning = true;
    document.getElementById("playBtn").innerText = "â¸";

    const time = sequence[currentIndex];
    totalSeconds = convertToSeconds(time);
    updateDisplay();

    timerInterval = setInterval(() => {
        if (totalSeconds > 0) {
            totalSeconds--;
            updateDisplay();
        } else {
            clearInterval(timerInterval);
            currentIndex++;
            isRunning = false;
            togglePlay();
        }
    }, 1000);
}

function pauseTimer() {
    clearInterval(timerInterval);
    isRunning = false;
    document.getElementById("playBtn").innerText = "â–¶";
}

function convertToSeconds(time) {
    const parts = time.split(":");
    return parseInt(parts[0]) * 60 + parseInt(parts[1]);
}

function updateDisplay() {
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    document.getElementById("totalTime").innerText =
        String(minutes).padStart(2, "0") + ":" +
        String(seconds).padStart(2, "0");
}

/* =========================
   CLEAR
========================= */

function clearNotes() {
    document.getElementById("notes").value = "";
    pauseTimer();
    currentIndex = 0;
    sequence = [];
    document.getElementById("totalTime").innerText = "00:00";
}

/* =========================
   TECLADO
========================= */

function showPhoneKeyboard() {
    document.getElementById("keyboard").style.display = "block";
}

function insertText(value) {
    const textarea = document.getElementById("notes");
    textarea.value += value;
}

function backspace() {
    const textarea = document.getElementById("notes");
    textarea.value = textarea.value.slice(0, -1);
}

/* =========================
   TAREFAS + CORES
========================= */

let activeColor = null;

function addTask() {
    const taskName = prompt("Nome da tarefa:");
    if (!taskName) return;

    const task = document.createElement("div");
    task.innerText = taskName;
    task.classList.add("task");
    task.dataset.color = "";

    task.onclick = function () {
        showColorOptions(task);
    };

    document.getElementById("tasks").appendChild(task);
}

function showColorOptions(task) {
    const colors = ["blue", "yellow", "red", "purple"];
    const choice = prompt("Escolha a cor:\nblue\nyellow\nred\npurple");

    if (!colors.includes(choice)) return;

    task.style.background = choice;
    task.dataset.color = choice;

    activateTaskColor(choice);
}

function activateTaskColor(color) {
    activeColor = color;
    document.getElementById("screen").style.background = color;
}
</script>


</body>
</html>

